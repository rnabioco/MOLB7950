{
  "hash": "90a1103696585b32f4baacce59d9fa03",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"RNA Block - Problem Set 24\"\n---\n\n\n\n## Problem Set\n\nTotal points: 20. Q1 - 10 pts, Q2,3 - 5 points each.\n\n1. Perform differential expression analysis comparing DIV28 vs DIV0 (10 pts)\n\n2. Are axonogenesis and cell cycle genes significantly differentially expressed? If so, in what direction (up/down-regulated)?\n\n2. Perform GSEA analysis using the Hallmark gene set. Make enrichment plot of `HALLMARK_G2M_CHECKPOINT` geneset.\n\n\n## Load libraries and generate gene information files (0 pts)\n\nMake sure to run the code chunk below to load required libraries and generate `t2g` (file for `tximport`) and gene id to symbol mapping file.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(biomaRt)\nlibrary(tximport)\nlibrary(tidyverse)\nlibrary(DESeq2)\nlibrary(ggrepel)\nlibrary(here)\nlibrary(cowplot)\nlibrary(rstatix)\nlibrary(clusterProfiler)\nlibrary(enrichplot)\nlibrary(msigdbr)\n# run the code below to generate t2g file and gene id-symbol mapping file\nmart <- biomaRt::useMart(\n  \"ENSEMBL_MART_ENSEMBL\",\n  dataset = \"mmusculus_gene_ensembl\"\n)\n\nt2g <- biomaRt::getBM(\n  attributes = c(\n    \"ensembl_transcript_id\",\n    \"ensembl_gene_id\",\n    \"external_gene_name\"\n  ),\n  mart = mart\n) |>\n  as_tibble()\n\n# maps systematic to common gene names\ngene_name_map <- t2g |>\n  dplyr::select(-ensembl_transcript_id) |>\n  unique()\n```\n:::\n\n\n\n\n## Q1 Perform differential expression analysis comparing DIV28 vs DIV0\n\n### Prepare `metadata` and use `tximport` {.smaller}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmetadata <- data.frame(\n  sample_id = list.files(here(\"data/block-rna/salmonouts\"),\n    pattern = \"^DIV\"\n  ),\n  salmon_dirs = list.files(here(\"data/block-rna/salmonouts\"),\n    recursive = T,\n    pattern = \".gz$\",\n    full.names = T\n  )\n) |>\n  separate(col = sample_id, into = c(\"timepoint\", \"rep\"), sep = \"\\\\.\", remove = F)\n\nmetadata$rep <- gsub(pattern = \"Rep\", replacement = \"\", metadata$rep)\n\nrownames(metadata) <- metadata$sample_id\n\nmetadata <- metadata |>\n  filter(timepoint %in% c(\"DIV0\", \"DIV28\"))\n\nsalmdir <- metadata$salmon_dirs\nnames(salmdir) <- metadata$sample_id\n\ntxi <- tximport(\n  files = salmdir,\n  type = \"salmon\",\n  tx2gene = t2g,\n  dropInfReps = TRUE,\n  countsFromAbundance = \"lengthScaledTPM\"\n)\n```\n:::\n\n\n\n### Filter genes and perform `DESeq2` {.smaller}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# examine distribution of TPMs\nhist(log2(1 + rowSums(txi$abundance)), breaks = 40)\n\n# decide a cutoff\nkeepG <- txi$abundance[log2(1 + rowSums(txi$abundance)) > 4.5, ] |>\n  rownames()\n\nddsTxi <- DESeqDataSetFromTximport(\n  txi,\n  colData = metadata,\n  design = ~timepoint\n)\n\n# keep genes with sufficient expession\nddsTxi <- ddsTxi[keepG, ]\n\n# run DESeq2\ndds <- DESeq(ddsTxi)\n\n# create a dataframe containing results and join w/gene symbols\ndiff <-\n  results(\n    dds,\n    contrast = c(\"timepoint\", \"DIV28\", \"DIV0\")\n  ) |>\n  # Change this into a dataframe\n  as.data.frame() |>\n  # Move ensembl gene IDs into their own column\n  rownames_to_column(var = \"ensembl_gene_id\") |>\n  # drop unused columns\n  dplyr::select(-c(baseMean, lfcSE, stat, pvalue)) |>\n  # Merge this with a table relating ensembl_gene_id with gene short names\n  inner_join(gene_name_map) |>\n  # Rename external_gene_name column\n  dplyr::rename(gene = external_gene_name) |>\n  as_tibble()\n```\n:::\n\n\n\n## Q2. Are axonogenesis and cell cycle genes significantly differentially expressed? If so, in what direction (up/down-regulated)?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncellcyclegenes <- getBM(\n  attributes = c(\"ensembl_gene_id\"),\n  filters = c(\"go_parent_term\"),\n  values = c(\"GO:0045787\"),\n  mart = mart\n)\n\n\naxongenes <- getBM(\n  attributes = c(\"ensembl_gene_id\"),\n  filters = c(\"go_parent_term\"),\n  values = c(\"GO:0007409\"),\n  mart = mart\n)\n\ndiff_paths <-\n  diff |>\n  mutate(\n    annot = case_when(\n      ensembl_gene_id %in% axongenes$ensembl_gene_id ~ \"axonogenesis\",\n      ensembl_gene_id %in% cellcyclegenes$ensembl_gene_id ~ \"cellcycle\",\n      .default = \"none\"\n    )\n  ) |>\n  drop_na() # drop na\n\n# Reorder these for plotting purposes\ndiff_paths$annot <-\n  factor(\n    diff_paths$annot,\n    levels = c(\"none\", \"axonogenesis\", \"cellcycle\")\n  )\n\n# calculate and report p-value using wilcox test\npvals <- wilcox_test(\n  data = diff_paths,\n  log2FoldChange ~ annot,\n  ref.group = \"none\"\n)\n\n# make a plot of the LFC (y-axis) ~ pathways (x-axis)\nggplot(\n  diff_paths,\n  aes(\n    x = annot,\n    y = log2FoldChange,\n    fill = annot\n  )\n) +\n  labs(\n    x = \"Gene class\",\n    y = \"DIV28/DIV0, log2\"\n  ) +\n  geom_hline(\n    yintercept = 0,\n    color = \"gray\",\n    linetype = \"dashed\"\n  ) +\n  geom_boxplot(\n    notch = TRUE,\n    outlier.shape = NA\n  ) +\n  ylim(-5, 5) +\n  theme_cowplot()\n```\n:::\n\n\n\n\n\n## Q3. Perform GSEA analysis using the Hallmark gene set.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# retrieve mouse hallmark gene set from msigdb\nmouse_hallmark <- msigdbr(species = \"Mus musculus\") %>%\n  filter(gs_cat == \"H\") %>%\n  dplyr::select(gs_name, gene_symbol)\n\n\n# create a list of gene LFCs\nrankedgenes <- diff %>% pull(log2FoldChange)\n\n# add symbols as names of the list\nnames(rankedgenes) <- diff$gene\n\n# sort by LFC\nrankedgenes <- sort(rankedgenes, decreasing = TRUE)\n\n# deduplicate\nrankedgenes <- rankedgenes[!duplicated(names(rankedgenes))]\n\n\n# run gsea\ndiv28vs0 <- GSEA(\n  geneList = rankedgenes,\n  eps = 0,\n  pAdjustMethod = \"fdr\",\n  pvalueCutoff = .05,\n  minGSSize = 20,\n  maxGSSize = 1000,\n  TERM2GENE = mouse_hallmark\n)\n\n\n# plot \"HALLMARK_G2M_CHECKPOINT\"\ngseaplot(x = div28vs0, geneSetID = \"HALLMARK_G2M_CHECKPOINT\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}