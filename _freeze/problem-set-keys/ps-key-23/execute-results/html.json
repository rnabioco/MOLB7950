{
  "hash": "5d3be82310655163494bd5662fe31478",
  "result": {
    "markdown": "---\ntitle: \"RNA Block - Problem Set 23\"\n---\n\n\n## Problem Set\n\nTotal points: 20. First problem is worth 10 points, second and third problems are worth 5 points.\n\n## Load libraries\n\nStart by loading libraries you need analysis in the code chunk below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.3          ✔ readr     2.1.4     \n✔ forcats   1.0.0          ✔ stringr   1.5.0     \n✔ ggplot2   3.4.3          ✔ tibble    3.2.1     \n✔ lubridate 1.9.3          ✔ tidyr     1.3.0     \n✔ purrr     1.0.2.9000     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(biomaRt)\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nhere() starts at /Users/nmukherjee/Dropbox/My Mac (Neelanjan’s MacBook Pro)/Documents/GitHub/molb-7950\n```\n:::\n\n```{.r .cell-code}\nlibrary(tximport)\nlibrary(pheatmap)\nlibrary(gt)\nlibrary(ggrepel)\nlibrary(cowplot)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'cowplot'\n\nThe following object is masked from 'package:lubridate':\n\n    stamp\n```\n:::\n:::\n\n\n\nWe have an experiment where we can take neuronal cells and mechanically separate them into soma and neurite fractions.  By sequencing RNA from both of these fractions and comparing the relative abundances of RNAs, we can get a sense of how neurite-localized every RNA is. We can also combine this approach with knockouts of specific RBPs. If we have an RBP that we think is involved in this process, we can do this subcellular fractionation in sequencing in both WT and RBP-knockout (KO) cells. Transcripts that depend upon the RBP for transcript to the neurite should be less neurite-enriched in the KO samples than the WT samples.\n\nWe recently completed this process in mouse cells that lack the RBP TDP-43.  We have RNA sequence data for 4 conditions: WT soma, WT neurite, KO soma, and KO neurite with 3 replicates of each condition.  These samples have been quantified with `salmon`. \n\nRead in this data, collapse `salmon`'s transcript-level quantification to gene-level quantification with `tximport`.  Then assess the quality of this data by performing hierarchical clustering of pairwise spearman correlation values and PCA analysis of TPM expression values.\n\nThe salmon data lives in `data/block-rna/salmon_tdp43`. In that directory, you will find one `salmon` output directory for each sample.\n\n## Q1: read in salmon data (10 pts) \n\n\n::: {.cell}\n\n```{.r .cell-code}\n#There are some hints to help you get started\n\n#Use biomaRt to get a table of transcript/gene relationships\nmart <- biomaRt::useMart(\n  \"ENSEMBL_MART_ENSEMBL\",\n  dataset = \"mmusculus_gene_ensembl\",\n  host = \"www.ensembl.org\"\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Ensembl will soon enforce the use of https.\nEnsure the 'host' argument includes \"https://\"\n```\n:::\n\n```{.r .cell-code}\nt2g <- biomaRt::getBM(attributes = c(\"ensembl_transcript_id\", \"ensembl_gene_id\", \"external_gene_name\"), mart = mart) |> dplyr::select(ensembl_transcript_id, ensembl_gene_id)\n\n\n\n#Read in salmon quantification files\n\n\n\nmetadata <- data.frame(sample_id = list.files(here(\"data/block-rna/salmon_tdp43\")),\n                   salmon_dirs = list.files(here(\"data/block-rna/salmon_tdp43\"),recursive = T,pattern = \".gz$\", full.names = T)\n\n                   ) |> \n  separate(col = sample_id, into = c(\"cell\",\"loc\",\"geno\",\"rep\"), sep = \"_\", remove = F)\n\nmetadata$rep <- gsub(pattern = \"Rep\", replacement = \"\", metadata$rep) \n\nrownames(metadata) <- metadata$sample_id\n\n\n#Get gene-level TPM values with tximport\n\nsalmdir <- metadata$salmon_dirs\nnames(salmdir) <- metadata$sample_id\n\n\ntxi <- tximport(files = salmdir,\n  type = \"salmon\",\n  tx2gene = t2g,\n  dropInfReps = TRUE,\n  countsFromAbundance = \"lengthScaledTPM\"\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nreading in files with read_tsv\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n1 2 3 4 5 6 7 8 9 10 11 12 \ntranscripts missing from tx2gene: 4204\nsummarizing abundance\nsummarizing counts\nsummarizing length\n```\n:::\n\n```{.r .cell-code}\n#Filter genes to remove those that are not expressed at at least 1 TPM in EVERY sample\ntpms <- txi$abundance |>\n  as.data.frame() |>\n  rownames_to_column(var = \"ensembl_gene_id\")\n\n\ntpms.cutoff <-\n  mutate(tpms, nSamples = rowSums(tpms[, 2:13] > 1)) |>\n  # Now filter for rows where nSamples is at least 12\n  # Meaning that at least 12 samples passed the threshold\n  filter(nSamples >= 12) |>\n  # Get rid of the nSamples column\n  dplyr::select(-nSamples)\n```\n:::\n\n\n\n## Q2: make correlation heatmap (5 pts)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Use cor() to get a matrix of pairwise correlations between samples\ntpms.cor <- cor(tpms.cutoff[,-1], method = \"spearman\")\n\n#Use pheatmap() to plot correlation matrix\npheatmap(\n  tpms.cor,\n  annotation_col = metadata[,3:5],\n  fontsize = 7,\n  show_colnames = FALSE\n)\n```\n\n::: {.cell-output-display}\n![](ps-key-23_files/figure-html/clustering-1.png){width=672}\n:::\n:::\n\n\n> Provide 1-2 sentences of interpretation of the similarity of the samples based on the heatmap.\n\nThe biggest differences are betweent soma and neurite. Then the WT vs KO. The replicates cluster together nicely.\n\n\n## Q3: make PCA plot (5 pts)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Start with the filtered TPM table from above\ntpms.cutoff.matrix <-\n  dplyr::select(tpms.cutoff, -ensembl_gene_id) |>\n  as.matrix()\n\n\n#Use prcomp() to derive principle component coordinants of *LOGGED*  and *Scaled* TPM values\ntpms.cutoff.matrix <- log2(tpms.cutoff.matrix + 1e-3)\n\ntpms.cutoff.matrix <- t(scale(t(tpms.cutoff.matrix)))\n\ntpms.pca <- prcomp(t(tpms.cutoff.matrix))\n#Add annotations of the cell compartment (soma / neurite) and TDP-43 status (WT / KO) of the samples\ntpms.pca.pc <- tpms.pca$x %>%\n  as.data.frame() %>%\n  rownames_to_column(var = \"sample_id\") %>% \n  left_join(., metadata[,c(1,3:5)], by = \"sample_id\")\n\n## \n\ntpms.pca.summary <- summary(tpms.pca)$importance\npc1var <- round(tpms.pca.summary[2, 1] * 100, 1)\npc2var <- round(tpms.pca.summary[2, 2] * 100, 1)\n\n#Plot PCA data\n\nggplot(data = tpms.pca.pc,\n  aes(\n    x = PC1, y = PC2,\n    color = paste(loc,geno), label = sample_id\n  )\n) +\n  geom_point(size = 5) +\n  scale_color_brewer(palette = \"Set1\") +\n  theme_cowplot(16) +\n  labs(\n    x = paste(\"PC1,\", pc1var, \"% explained var.\"),\n    y = paste(\"PC2,\", pc2var, \"% explained var.\")\n  ) +\n  geom_text_repel()\n```\n\n::: {.cell-output-display}\n![](ps-key-23_files/figure-html/pca-1.png){width=672}\n:::\n:::\n\n\n> Provide 1-2 sentences of interpretation of the similarity of the samples based on the heatmap.\n\nPC1, which explains ~86% of the variance is correlating with the difference between soma and neurite. PC2, which explains ~6% of the variance is correlating with the difference between WT and KO.The replicates group together nicely.\n",
    "supporting": [
      "ps-key-23_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}