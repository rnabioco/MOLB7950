{
  "hash": "7bc754a60540bb7d1383bf41ad2ada0d",
  "result": {
    "markdown": "---\ntitle: \"Chromatin accessibility I\"\nsubtitle: \"Chromatin-centric measurement of genomic features\"\nauthor: \"Jay Hesselberth\"\n---\n\n\n## Load the libraries \n\n1.  rtracklayer - prov\n2.  Gviz - this is a way to generate pretty images of genome browser snapshots within Rstudio.\n\nThese tools are useful for us to look at the data directly, and are great use to you when you write papers and want to create nice plots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(cowplot)\nlibrary(here)\nlibrary(patchwork)\n\nlibrary(valr)\nlibrary(Gviz)\nlibrary(rtracklayer)\n\nlibrary(TxDb.Scerevisiae.UCSC.sacCer3.sgdGene)\n```\n:::\n\n\n## Load the data\n\nIn this and the next class we will analyze ATAC-seq and MNase-seq data sets from budding yeast. Here are the references for the two data set:\n\n#### ATAC-seq\n\n> Schep AN, Buenrostro JD, Denny SK, Schwartz K, Sherlock G, Greenleaf WJ. Structured nucleosome fingerprints enable high-resolution mapping of chromatin architecture within regulatory regions. Genome Res. 2015 PMID: 26314830; PMCID: PMC4617971. [[Link]](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4617971/) [[Data]](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE66386)\n\n#### MNase-seq\n\n> Zentner GE, Henikoff S. Mot1 redistributes TBP from TATA-containing to TATA-less promoters. Mol Cell Biol. 2013 PMID: 24144978; PMCID: PMC3889552. [[Link]](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3889552/) [[Data]](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE44200)\n\n### Considerations\n\nIn a standard MNase-seq experiment, DNA around 150 bp is extracted, so as to look closely at nucleosome occupancy & positioning. However, the study we are analyzing today did not perform size selection. This is important as now we can look at both transcription factor binding sites and nucleosome positions.\n\nFirst, we will determine the fragment size distributions obtained from the two experiments. These sizes are the fingerprints of particles that were protecting the DNA inside the cells.\n\nI have performed the alignment of paired-end reads and converted all reads into a bed file where each line of the bed file denotes a single fragment from start to end.\n\nFirst, load the ATAC-seq reads:\n\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\natac_tbl <- read_bed(\n  here(\"data/block-dna/yeast_atac_chrII.bed.gz\"),\n) \natac_tbl\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 409,870 x 3\n   chrom start   end\n   <chr> <int> <int>\n 1 chrII     0    42\n 2 chrII     0    52\n 3 chrII     0    71\n 4 chrII     0    75\n 5 chrII     0    82\n 6 chrII     0    83\n 7 chrII     0    83\n 8 chrII     0    83\n 9 chrII     0   122\n10 chrII     0   135\n# i 409,860 more rows\n```\n\n\n:::\n:::\n\n\nNext, load the MNase reads.\n\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nmnase_tbl <- read_bed(\n  here(\"data/block-dna/yeast_mnase_chrII.bed.gz\")\n)\nmnase_tbl\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,236,334 x 3\n   chrom start   end\n   <chr> <int> <int>\n 1 chrII     1   228\n 2 chrII     2    80\n 3 chrII     3   226\n 4 chrII     4    60\n 5 chrII     4    66\n 6 chrII     4    77\n 7 chrII     4    81\n 8 chrII     5    56\n 9 chrII     5    60\n10 chrII     5    60\n# i 1,236,324 more rows\n```\n\n\n:::\n:::\n\n\nWorking with a small genome is a huge advantage -- we can study the whole chromosome in this class. For *Drosophila* and human data we dealt with before, we were looking at a subsection of the chromosome.\n\n## Expectations for chromatin fragment lengths\n\nLet's remind ourselves of the expectations for chromatin fragment lengths from MNase-seq and ATAC-seq experiments.\n\n### MNase-seq\n\n![](../img/block-dna/mnase-overview.png)\n\n### ATAC-seq\n\n![](../img/block-dna/atac-explain.png)\n\n## Length distributions of chromatin-derived DNA fragments\n\nFor the MNase-seq BED file, you see that there are only three columns: `chrom`, `start`, and `end`. Calculating fragment length is very simple:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmutate(mnase_tbl, frag_len = end - start)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,236,334 x 4\n   chrom start   end frag_len\n   <chr> <int> <int>    <int>\n 1 chrII     1   228      227\n 2 chrII     2    80       78\n 3 chrII     3   226      223\n 4 chrII     4    60       56\n 5 chrII     4    66       62\n 6 chrII     4    77       73\n 7 chrII     4    81       77\n 8 chrII     5    56       51\n 9 chrII     5    60       55\n10 chrII     5    60       55\n# i 1,236,324 more rows\n```\n\n\n:::\n:::\n\n\nLet's use this approach to examine the fragment length distribution.\n\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nacc_tbl <-\n  bind_rows(\n    mutate(mnase_tbl, type = \"mnase\"),\n    mutate(atac_tbl, type = \"atac\")\n  )\n\nggplot(\n  acc_tbl,\n  aes(x = end - start)\n  ) +\n  geom_histogram(\n    # single base-pair resolution\n    binwidth = 1\n  ) + \n  facet_grid(\n    rows = vars(type),\n    scales = \"free_y\"\n    ) +\n  xlim(30, 500) +\n  labs(x = \"fragment length (bp)\") +\n  theme_cowplot()\n```\n\n::: {.cell-output-display}\n![](ex-17_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### Interpreations\n\n1.  How would you describe the two distributions? Are they similar?\n\n2.  Can you make any biological conclusions based on the length distributions?\n\n## Periodicity in the fragment lengths\n\nThe ATAC data seems to be periodic. How can we test that hypothesis? We can calculate the autocorrelation of the length distribution. Can someone explain what [autocorrelation](https://en.wikipedia.org/wiki/Autocorrelation) means?\n\nWe'll use the base `hist` function to calculate the densities of the above histogram. Let's write a function we can use to analyze fragment lengths.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfragment_len_hist <- function(tbl) {\n  frag_lens <- \n    mutate(\n      tbl,\n      frag_len = end - start\n    ) |>\n    filter(\n      frag_len >= 30 &\n        frag_len <= 500\n    ) |>\n    pull(frag_len)\n  \n  hist(\n    frag_lens,\n    breaks = seq(30, 500, 1),\n    plot = FALSE\n  )\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\natac_frag_lens <- fragment_len_hist(atac_tbl)\n```\n:::\n\n\nThe `density` slot contains a vector of densities at base-pair resolution. We will use `acf()` to calculate the autocorrelation of these values, and will store the tidied result.\n\n\n::: {.cell}\n\n```{.r .cell-code}\natac_acf_tbl <-\n  acf(\n    atac_frag_lens$density,\n    lag.max = 40,\n    plot = FALSE\n  ) |>\n    broom::tidy()\n\natac_acf_tbl\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 41 x 2\n     lag   acf\n   <dbl> <dbl>\n 1     0 1    \n 2     1 0.975\n 3     2 0.937\n 4     3 0.916\n 5     4 0.909\n 6     5 0.902\n 7     6 0.891\n 8     7 0.882\n 9     8 0.877\n10     9 0.887\n# i 31 more rows\n```\n\n\n:::\n:::\n\n\nNow let's plot the autocorrelation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_acf <- function(tbl, title) {\n  ggplot(\n    tbl,\n    aes(lag, acf)\n  ) +\n    geom_point(size = 2) +\n    geom_line() +\n    theme_minimal_grid() +\n    geom_vline(xintercept = c(10, 21), color = 'red') +\n    labs(title = title)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_atac_acf <- plot_acf(atac_acf_tbl, title = \"ATAC ACF\")\nplot_atac_acf\n```\n\n::: {.cell-output-display}\n![](ex-17_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nSo, it looks like there significant bumps in autocorrelation at 10 and 21 bp positions, indicating that ATAC length distribution is periodic.\n\nHow do we confirm these bumps are interesting? Let's calculate the acf of a negative control -- the length distribution of the MNase data.\n\n\n::: {.cell output-location='default'}\n\n```{.r .cell-code}\nmnase_frag_lens <-\n  fragment_len_hist(mnase_tbl)\n\nmnase_acf_tbl <-\n  acf(\n    mnase_frag_lens$density,\n    lag.max = 40,\n    plot = FALSE\n  ) |>\n  broom::tidy()\n\nplot_mnase_acf <- plot_acf(mnase_acf_tbl, title = \"MNase ACF\")\n\n# patchwork plot\nplot_atac_acf / plot_mnase_acf\n```\n\n::: {.cell-output-display}\n![](ex-17_files/figure-html/plot-acfs-1.png){width=672}\n:::\n:::\n\n\nWe can see a monotonic decrease in the MNase-seq data, which confirms that the bumps we see are distinctive features of ATAC-seq data.\n\n## Visualize read density in genomic region {.smaller}\n\nWe will use Gviz to visualize read densities relative to a reference.\n\n### Load tracks\n\nFirst, we load the gene annotations from the [Saccharomyces Genome Databases](https://yeastgenome.org) (SGD).\n\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nsgd_genes <-\n  GeneRegionTrack(\n    TxDb.Scerevisiae.UCSC.sacCer3.sgdGene,\n    chromosome = \"chrII\",\n    start = 530811,\n    end = 540885,\n  )\n\nsgd_genes\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGeneRegionTrack 'GeneRegionTrack'\n| genome: sacCer3\n| active chromosome: chrII\n| annotation features: 7\n```\n\n\n:::\n:::\n\n\nNext, import the bigwig file containing yeast nucleosome-sized fragments (via MNase-seq) using `rtracklayer::import.bw()`.\n\nInspect the object. What is \"GRanges\"?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmnase_nuc_gr <- import.bw(\n  here(\"data/block-dna/yeast_mnase_134_160.bw\"),\n  as = \"GRanges\"\n)\nmnase_nuc_gr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGRanges object with 81160 ranges and 1 metadata column:\n          seqnames        ranges strand |     score\n             <Rle>     <IRanges>  <Rle> | <numeric>\n      [1]    chrII         10-19      * |   3.81086\n      [2]    chrII         20-29      * |   3.81086\n      [3]    chrII         30-39      * |   5.71629\n      [4]    chrII         40-49      * |   5.71629\n      [5]    chrII         50-59      * |   5.71629\n      ...      ...           ...    ... .       ...\n  [81156]    chrII 813130-813139      * |  15.24344\n  [81157]    chrII 813140-813149      * |   7.62172\n  [81158]    chrII 813150-813159      * |   7.62172\n  [81159]    chrII 813160-813169      * |   7.62172\n  [81160]    chrII 813170-813179      * |   5.71629\n  -------\n  seqinfo: 1 sequence from an unspecified genome\n```\n\n\n:::\n:::\n\n\nNext, load the GRanges object as a track for Gviz to plot:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmnase_nuc_trk <- DataTrack(\n  mnase_nuc_gr,\n  name = \"MNase_nuc\"\n)\nmnase_nuc_trk\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataTrack 'MNase_nuc'\n| genome: NA\n| active chromosome: chrII\n| positions: 81160\n| samples:1\n| strand: * \n```\n\n\n:::\n:::\n\n\nNow, we can make a plot for this particular region of chrII:\n\n\n::: {.cell output-location='column'}\n\n```{.r .cell-code}\nplotTracks(\n  c(sgd_genes,\n    mnase_nuc_trk),\n  from = 530811,\n  to = 540885,\n  chromosome = \"chrII\",\n  transcriptAnnotation = \"gene\",\n  shape = \"arrow\",\n  type = \"histogram\"\n)\n```\n\n::: {.cell-output-display}\n![](ex-17_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n## Load the remaining data\n\nThat looks great! Let's load all the other data sets.\n\n1.  Load each bigWig as a GRanges object with `rtracklayer::import.bw()`\n2.  Convert each to a `Gviz::DataTrack()` for plotting\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrack_info <-\n  tibble(\n    file_name = c(\n      \"yeast_mnase_lt50.bw\",\n      \"yeast_mnase_134_160.bw\",\n      \"yeast_atac_lt120.bw\",\n      \"yeast_atac_gt120.bw\"\n    ),\n    track_name = c(\n      \"MNase_Short\", \"MNase_Long\",\n      \"ATAC_Short\", \"ATAC_Long\"\n    )\n  ) |>\n  mutate(\n    file_path = here(\"data/block-dna\", file_name),\n    big_wig = purrr::map(\n      file_path, ~ import.bw(.x, as = \"GRanges\")\n    ),\n    data_track = purrr::map2(\n      big_wig, track_name, ~ DataTrack(.x, name = .y)\n    )\n  )\n```\n:::\n\n\nNow, we just have to make a list of tracks to plot and Gviz takes care of the rest.\n\n\n::: {.cell output-location='column-fragment'}\n\n```{.r .cell-code}\nplotTracks(\n  c(sgd_genes,\n    track_info$data_track),\n  from = 530811,\n  to = 540885,\n  chromosome = \"chrII\",\n  transcriptAnnotation = \"gene\",\n  shape = \"arrow\",\n  type = \"histogram\"\n)\n```\n\n::: {.cell-output-display}\n![](ex-17_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n## Interpretations\n\nRecall this plot:\n\n![](../img/block-dna/mnase-overview.png)\n\nSome questions to think about as you look at the tracks:\n\n1.  What is each data set reporting on?\n2.  What can you infer about genome function based on these tracks?\n3.  What are the major differences between MNase-seq and ATAC-seq based on these tracks?\n",
    "supporting": [
      "ex-17_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}